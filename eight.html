<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background: #fce4ec;
    text-align: center;
    font-family: Arial;
  }
  #cake {
    width: 250px;
    margin-top: 40px;
  }
  .candle {
    width: 8px;
    height: 30px;
    background: yellow;
    position: absolute;
    border-radius: 3px;
  }
  .flame {
    width: 10px;
    height: 16px;
    background: orange;
    border-radius: 50%;
    position: absolute;
    top: -16px;
    left: -1px;
  }
  #canvas {
    position: relative;
    display: inline-block;
  }
</style>
</head>
<body>



<div id="canvas">
  <img id="cake" src="cake.png">
</div>

<script>
let canvas = document.getElementById("canvas");
let candles = [];
let blowingThreshold = 0.2; // mic volume level to blow out

// --- ADD CANDLES ON TOUCH/CLICK ---
canvas.addEventListener("click", (e) => {
  let rect = canvas.getBoundingClientRect();
  let x = e.clientX - rect.left;

  let candle = document.createElement("div");
  candle.className = "candle";
  candle.style.left = (x - 4) + "px";
  candle.style.top = "150px";

  let flame = document.createElement("div");
  flame.className = "flame";
  candle.appendChild(flame);

  canvas.appendChild(candle);
  candles.push({candle, flame, lit: true});
});

// --- MICROPHONE & BLOW DETECTION ---
async function startMic() {
  let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  let audioCtx = new AudioContext();
  let mic = audioCtx.createMediaStreamSource(stream);
  let analyser = audioCtx.createAnalyser();
  mic.connect(analyser);

  let data = new Uint8Array(analyser.fftSize);

  function checkBlow() {
    analyser.getByteTimeDomainData(data);

    // measure average loudness
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      let v = (data[i] - 128) / 128;
      sum += Math.abs(v);
    }
    let volume = sum / data.length;

    if (volume > blowingThreshold) {
      blowOutCandles();
    }

    requestAnimationFrame(checkBlow);
  }
  checkBlow();
}

function blowOutCandles() {
  candles.forEach(c => {
    if (c.lit) {
      c.flame.style.display = "none";
      c.lit = false;
    }
  });
}

startMic();
</script>

</body>
</html>
